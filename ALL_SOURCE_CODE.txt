================================================================================
                    SECURE AUTHENTICATION SYSTEM
                    COMPLETE SOURCE CODE LISTING
================================================================================

Last Updated: December 9, 2025
Version: 3.0 - User Sign-Up with SQLite Database

This document contains all source code files for the Secure Authentication
System featuring user registration, SQLite database, per-user TOTP secrets,
and modern Windows 11 glass UI.

================================================================================ 
FILE 1: user_db.py - SQLite User Database Module (NEW)
================================================================================

"""
User Database Module
Handles user registration, authentication, and TOTP secret management using SQLite.
"""

import sqlite3
import hashlib
import pyotp
import os

DB_FILENAME = "users.db"


def init_db():
    """Initialize the database and create tables if they don't exist"""
    conn = sqlite3.connect(DB_FILENAME)
    cursor = conn.cursor()
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            username TEXT PRIMARY KEY,
            password_hash TEXT NOT NULL,
            totp_secret TEXT NOT NULL
        )
    """)
    
    conn.commit()
    conn.close()


def hash_password(password):
    """Hash a password using SHA-256"""
    return hashlib.sha256(password.encode('utf-8')).hexdigest()


def generate_totp_secret():
    """Generate a random Base32 TOTP secret for Google Authenticator"""
    return pyotp.random_base32()


def register_user(username, password):
    """
    Register a new user with username and password.
    Returns (success: bool, message: str, totp_secret: str or None)
    """
    if not username or not password:
        return False, "Username and password cannot be empty", None
    
    if len(username) < 3:
        return False, "Username must be at least 3 characters", None
    
    if len(password) < 6:
        return False, "Password must be at least 6 characters", None
    
    # Check if user already exists
    if user_exists(username):
        return False, "Username already exists", None
    
    # Hash password and generate TOTP secret
    pwd_hash = hash_password(password)
    totp_secret = generate_totp_secret()
    
    # Store in database
    try:
        conn = sqlite3.connect(DB_FILENAME)
        cursor = conn.cursor()
        cursor.execute(
            "INSERT INTO users (username, password_hash, totp_secret) VALUES (?, ?, ?)",
            (username, pwd_hash, totp_secret)
        )
        conn.commit()
        conn.close()
        return True, "Registration successful", totp_secret
    except Exception as e:
        return False, f"Database error: {str(e)}", None


def validate_credentials(username, password):
    """
    Validate username and password.
    Returns True if credentials are valid, False otherwise.
    """
    if not username or not password:
        return False
    
    pwd_hash = hash_password(password)
    
    try:
        conn = sqlite3.connect(DB_FILENAME)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT password_hash FROM users WHERE username = ?",
            (username,)
        )
        result = cursor.fetchone()
        conn.close()
        
        if result and result[0] == pwd_hash:
            return True
        return False
    except Exception:
        return False


def get_user_secret(username):
    """
    Retrieve the TOTP secret for a given username.
    Returns the secret string or None if user not found.
    """
    try:
        conn = sqlite3.connect(DB_FILENAME)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT totp_secret FROM users WHERE username = ?",
            (username,)
        )
        result = cursor.fetchone()
        conn.close()
        
        if result:
            return result[0]
        return None
    except Exception:
        return None


def user_exists(username):
    """Check if a username already exists in the database"""
    try:
        conn = sqlite3.connect(DB_FILENAME)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT COUNT(*) FROM users WHERE username = ?",
            (username,)
        )
        count = cursor.fetchone()[0]
        conn.close()
        return count > 0
    except Exception:
        return False


def verify_totp(username, totp_code):
    """
    Verify a TOTP code for a given user.
    Returns True if valid, False otherwise.
    """
    secret = get_user_secret(username)
    if not secret:
        return False
    
    try:
        totp = pyotp.TOTP(secret)
        return totp.verify(totp_code, valid_window=1)
    except Exception:
        return False


# Initialize database on module import
if not os.path.exists(DB_FILENAME):
    init_db()


================================================================================
FILE 2: main_gui.py - Python GUI Frontend (Updated with Sign Up Feature)
================================================================================

import tkinter as tk
from tkinter import messagebox, font as tkfont
import ctypes
import os
import sys
import platform
import time
import math
import qrcode
from PIL import Image, ImageTk
import pyotp
import user_db

# Import configuration
try:
    from config import PRODUCTION_MODE, TOTP_SECRET, TOTP_SECRET_DEMO, APP_NAME, ISSUER, ACCOUNT_NAME
except ImportError:
    # Fallback to demo mode if config not found
    PRODUCTION_MODE = False
    TOTP_SECRET = "JBSWY3DPEHPK3PXP"
    TOTP_SECRET_DEMO = "MY_SUPER_SECRET_KEY"
    APP_NAME = "SecureAuthSystem"
    ISSUER = "SecureAuth"
    ACCOUNT_NAME = "admin"

# Create TOTP instance for production mode
if PRODUCTION_MODE:
    totp_generator = pyotp.TOTP(TOTP_SECRET)


class SetupWindow:
    """Window for Google Authenticator setup with QR code"""
    def __init__(self, parent, totp_secret=None, username="User"):
        self.window = tk.Toplevel(parent)
        self.window.title("Google Authenticator Setup")
        self.window.geometry("500x650")
        self.window.resizable(False, False)
        self.window.config(bg="#FFFFFF")
        
        # Store custom secret and username
        self.totp_secret = totp_secret if totp_secret else TOTP_SECRET
        self.username = username
        
        # Make modal
        self.window.transient(parent)
        self.window.grab_set()
        
        self.create_ui()
    
    def create_ui(self):
        # Title
        title = tk.Label(
            self.window,
            text="üì± Google Authenticator Setup",
            font=("Segoe UI", 20, "bold"),
            fg="#1A1A1A",
            bg="#FFFFFF"
        )
        title.pack(pady=(20, 10))
        
        # Instructions
        instructions = tk.Label(
            self.window,
            text="Scan this QR code with Google Authenticator app:",
            font=("Segoe UI", 11),
            fg="#666666",
            bg="#FFFFFF"
        )
        instructions.pack(pady=(0, 15))
        
        # Generate and display QR code
        qr_frame = tk.Frame(self.window, bg="#FFFFFF")
        qr_frame.pack(pady=10)
        
        qr_image = self.generate_qr_code()
        qr_label = tk.Label(qr_frame, image=qr_image, bg="#FFFFFF")
        qr_label.image = qr_image  # Keep reference
        qr_label.pack()
        
        # Manual entry section
        manual_frame = tk.Frame(self.window, bg="#F5F5F5", highlightthickness=1, 
                               highlightbackground="#E0E0E0")
        manual_frame.pack(fill=tk.X, padx=30, pady=20)
        
        manual_title = tk.Label(
            manual_frame,
            text="üìù Manual Entry",
            font=("Segoe UI Semibold", 11),
            fg="#1A1A1A",
            bg="#F5F5F5"
        )
        manual_title.pack(pady=(10, 5))
        
        manual_text = tk.Label(
            manual_frame,
            text="If you can't scan the QR code, enter manually:",
            font=("Segoe UI", 9),
            fg="#666666",
            bg="#F5F5F5"
        )
        manual_text.pack()
        
        # Secret key display
        secret_frame = tk.Frame(manual_frame, bg="#FFFFFF", 
                               highlightthickness=1, highlightbackground="#D0D0D0")
        secret_frame.pack(fill=tk.X, padx=15, pady=10)
        
        secret_label = tk.Label(
            secret_frame,
            text=f"Secret Key: {self.totp_secret}",
            font=("Consolas", 10, "bold"),
            fg="#0078D4",
            bg="#FFFFFF"
        )
        secret_label.pack(pady=8)
        
        # Step-by-step guide
        steps_frame = tk.Frame(self.window, bg="#FFFFFF")
        steps_frame.pack(fill=tk.X, padx=30, pady=(10, 20))
        
        steps = [
            "1. Open Google Authenticator app",
            "2. Tap '+' to add an account",
            "3. Choose 'Scan QR code' or 'Enter setup key'",
            "4. Scan the QR code above (or enter the secret key)",
            "5. Your app will generate 6-digit codes every 30 seconds"
        ]
        
        for step in steps:
            step_label = tk.Label(
                steps_frame,
                text=step,
                font=("Segoe UI", 9),
                fg="#333333",
                bg="#FFFFFF",
                anchor="w"
            )
            step_label.pack(fill=tk.X, pady=2)
        
        # Close button
        close_btn = tk.Button(
            self.window,
            text="Got it!",
            command=self.window.destroy,
            font=("Segoe UI Semibold", 11),
            bg="#0078D4",
            fg="#FFFFFF",
            relief=tk.FLAT,
            cursor="hand2",
            padx=30,
            pady=10
        )
        close_btn.pack(pady=(0, 20))
    
    def generate_qr_code(self):
        """Generate QR code for Google Authenticator"""
        # Create TOTP URI
        # Format: otpauth://totp/ISSUER:ACCOUNT?secret=SECRET&issuer=ISSUER
        totp_uri = f"otpauth://totp/{ISSUER}:{self.username}?secret={self.totp_secret}&issuer={ISSUER}"
        
        # Generate QR code
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_L,
            box_size=8,
            border=2,
        )
        qr.add_data(totp_uri)
        qr.make(fit=True)
        
        # Create image
        qr_image = qr.make_image(fill_color="black", back_color="white")
        
        # Convert to PhotoImage for tkinter
        qr_photo = ImageTk.PhotoImage(qr_image)
        
        return qr_photo


class GlassPanel(tk.Canvas):
    """Glass/Acrylic effect panel with blur simulation"""
    def __init__(self, parent, width, height, **kwargs):
        super().__init__(parent, width=width, height=height, highlightthickness=0, **kwargs)
        self.width = width
        self.height = height
        
        # Create frosted glass effect with gradient
        self.create_gradient()
        
    def create_gradient(self):
        """Simulate frosted glass with gradient layers"""
        # Base layer - semi-transparent white
        self.create_rectangle(0, 0, self.width, self.height, 
                            fill="#FFFFFF", stipple="gray50", outline="")
        
        # Border highlight (top edge light reflection)
        self.create_line(0, 0, self.width, 0, fill="#FFFFFF", width=2)


class ModernEntry(tk.Frame):
    """Custom rounded entry widget with glass styling"""
    def __init__(self, parent, placeholder="", show="", **kwargs):
        super().__init__(parent, bg="white", **kwargs)
        self.show = show
        self.placeholder = placeholder
        
        # Glass effect border
        self.config(bg="#E8E8E8", highlightthickness=1, highlightbackground="#D0D0D0")
        
        # Inner frame
        self.inner_frame = tk.Frame(self, bg="#FAFAFA", highlightthickness=0)
        self.inner_frame.pack(fill=tk.BOTH, expand=True, padx=2, pady=2)
        
        # Entry widget
        self.entry = tk.Entry(
            self.inner_frame, 
            font=("Segoe UI", 11),
            bg="#FAFAFA",
            fg="#1A1A1A",
            relief=tk.FLAT,
            insertbackground="#0078D4",
            show=show,
            bd=0
        )
        self.entry.pack(fill=tk.BOTH, expand=True, padx=12, pady=10)
        
        # Placeholder handling
        self.has_placeholder = False
        if placeholder:
            self.set_placeholder()
            self.entry.bind("<FocusIn>", self.on_focus_in)
            self.entry.bind("<FocusOut>", self.on_focus_out)
        
        # Focus effects
        self.entry.bind("<FocusIn>", self.on_entry_focus, add="+")
        self.entry.bind("<FocusOut>", self.on_entry_unfocus, add="+")
    
    def set_placeholder(self):
        self.entry.delete(0, tk.END)
        self.entry.insert(0, self.placeholder)
        self.entry.config(fg="#999999", show="")
        self.has_placeholder = True
    
    def on_focus_in(self, event):
        if self.has_placeholder:
            self.entry.delete(0, tk.END)
            self.entry.config(fg="#1A1A1A", show=self.show)
            self.has_placeholder = False
    
    def on_focus_out(self, event):
        if not self.entry.get():
            self.set_placeholder()
    
    def on_entry_focus(self, event):
        self.config(highlightbackground="#0078D4", highlightthickness=2)
    
    def on_entry_unfocus(self, event):
        self.config(highlightbackground="#D0D0D0", highlightthickness=1)
    
    def get(self):
        if self.has_placeholder:
            return ""
        return self.entry.get()


class ModernButton(tk.Canvas):
    """Custom button with glass effect and animations"""
    def __init__(self, parent, text="Button", command=None, primary=True, **kwargs):
        super().__init__(parent, height=48, highlightthickness=0, **kwargs)
        self.command = command
        self.primary = primary
        
        # Colors
        if primary:
            self.bg_color = "#0078D4"
            self.hover_color = "#106EBE"
            self.active_color = "#005A9E"
            self.text_color = "#FFFFFF"
        else:
            self.bg_color = "#F3F3F3"
            self.hover_color = "#E6E6E6"
            self.active_color = "#D4D4D4"
            self.text_color = "#1A1A1A"
        
        # Draw button
        self.config(bg=parent["bg"])
        self.rect = self.create_rectangle(
            0, 0, 1000, 48,
            fill=self.bg_color,
            outline="",
            width=0
        )
        
        # Add glass highlight
        self.highlight = self.create_rectangle(
            0, 0, 1000, 24,
            fill="#FFFFFF",
            stipple="gray25",
            outline=""
        )
        
        self.text = self.create_text(
            500, 24,
            text=text,
            fill=self.text_color,
            font=("Segoe UI Semibold", 12)
        )
        
        # Bind events
        self.bind("<Enter>", self.on_hover)
        self.bind("<Leave>", self.on_leave)
        self.bind("<Button-1>", self.on_click)
        self.bind("<ButtonRelease-1>", self.on_release)
        self.bind("<Configure>", self.on_resize)
    
    def on_resize(self, event):
        width = event.width
        self.coords(self.rect, 0, 0, width, 48)
        self.coords(self.highlight, 0, 0, width, 24)
        self.coords(self.text, width / 2, 24)
    
    def on_hover(self, event):
        self.itemconfig(self.rect, fill=self.hover_color)
    
    def on_leave(self, event):
        self.itemconfig(self.rect, fill=self.bg_color)
    
    def on_click(self, event):
        self.itemconfig(self.rect, fill=self.active_color)
    
    def on_release(self, event):
        self.itemconfig(self.rect, fill=self.hover_color)
        if self.command:
            self.command()


class PasswordStrengthMeter(tk.Canvas):
    """Visual password strength indicator"""
    def __init__(self, parent, **kwargs):
        super().__init__(parent, height=6, highlightthickness=0, **kwargs)
        self.strength = 0
        self.bars = []
        
        # Create 4 strength bars
        for i in range(4):
            bar = self.create_rectangle(
                i * 27, 0, i * 27 + 22, 6,
                fill="#E0E0E0",
                outline=""
            )
            self.bars.append(bar)
        
        self.bind("<Configure>", self.on_resize)
    
    def on_resize(self, event):
        width = event.width
        bar_width = (width - 15) / 4
        for i, bar in enumerate(self.bars):
            self.coords(bar, i * (bar_width + 5), 0, i * (bar_width + 5) + bar_width, 6)
    
    def update_strength(self, password):
        """Calculate and display password strength"""
        strength = 0
        if len(password) >= 8:
            strength += 1
        if any(c.isdigit() for c in password):
            strength += 1
        if any(c.isupper() for c in password) and any(c.islower() for c in password):
            strength += 1
        if any(c in "!@#$%^&*()_+-=[]{}|;:,.<>?" for c in password):
            strength += 1
        
        colors = ["#E0E0E0", "#D83B01", "#FFA500", "#FFD700", "#107C10"]
        
        for i, bar in enumerate(self.bars):
            if i < strength:
                self.itemconfig(bar, fill=colors[strength])
            else:
                self.itemconfig(bar, fill="#E0E0E0")


class CircularProgress(tk.Canvas):
    """Circular progress indicator for TOTP countdown"""
    def __init__(self, parent, size=60, **kwargs):
        super().__init__(parent, width=size, height=size, 
                        highlightthickness=0, **kwargs)
        self.size = size
        self.progress = 0
        
        # Background circle
        self.bg_arc = self.create_arc(
            5, 5, size-5, size-5,
            start=90, extent=360,
            fill="", outline="#E0E0E0",
            width=4, style=tk.ARC
        )
        
        # Progress arc
        self.progress_arc = self.create_arc(
            5, 5, size-5, size-5,
            start=90, extent=0,
            fill="", outline="#0078D4",
            width=4, style=tk.ARC
        )
        
        # Time text
        self.time_text = self.create_text(
            size/2, size/2,
            text="30",
            font=("Segoe UI", 14, "bold"),
            fill="#1A1A1A"
        )
    
    def set_progress(self, seconds_remaining, total_seconds=30):
        """Update progress ring"""
        progress = (seconds_remaining / total_seconds) * 360
        self.itemconfig(self.progress_arc, extent=-progress)
        self.itemconfig(self.time_text, text=str(seconds_remaining))
        
        # Color changes based on time remaining
        if seconds_remaining <= 5:
            self.itemconfig(self.progress_arc, outline="#D83B01")
        elif seconds_remaining <= 10:
            self.itemconfig(self.progress_arc, outline="#FFA500")
        else:
            self.itemconfig(self.progress_arc, outline="#107C10")


class SecureAuthApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Secure Authentication System")
        self.root.geometry("550x750")  # Increased height
        self.root.resizable(True, True)  # Allow resizing
        
        # State variables
        self.login_attempts = 0
        self.max_attempts = 5
        self.animation_alpha = 0
        self.current_username = None  # Store logged-in username
        self.pending_signup_secret = None  # Store secret during signup
        
        # Animated gradient background
        self.setup_animated_background()
        
        self.lib = self.load_library()
        
        # UI State
        self.current_stage = 1  # 1: Login, 2: MFA, 3: Signup, 4: QR Setup
        
        # Setup UI
        self.setup_ui()
        
        # Start TOTP updater
        self.update_demo_totp()
        
        # Start background animation
        self.animate_background()

    def setup_animated_background(self):
        """Create animated gradient background"""
        self.bg_canvas = tk.Canvas(self.root, highlightthickness=0)
        self.bg_canvas.place(x=0, y=0, relwidth=1, relheight=1)
        
        # Create gradient rectangles
        colors = ["#0078D4", "#106EBE", "#005A9E", "#004578"]
        for i in range(100):
            color_idx = int((i / 100) * (len(colors) - 1))
            color = colors[color_idx]
            self.bg_canvas.create_rectangle(
                0, i * 7, 600, (i + 1) * 7,
                fill=color, outline=""
            )

    def animate_background(self):
        """Subtle pulsing animation"""
        self.animation_alpha = (self.animation_alpha + 0.02) % (2 * math.pi)
        # Continue animation
        self.root.after(50, self.animate_background)

    def load_library(self):
        """Load C++ library (optional - only needed for legacy demo TOTP)"""
        system = platform.system()
        lib_name = "auth_lib.dll" if system == "Windows" else "auth_lib.so"
        lib_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), lib_name)
        
        # Library is optional now - we use Python DB for authentication
        if not os.path.exists(lib_path):
            print(f"Note: C++ library not found at {lib_path}")
            print("Using Python-only authentication (this is normal)")
            return None
            
        try:
            lib = ctypes.CDLL(lib_path)
            lib.validate_login.argtypes = [ctypes.c_char_p, ctypes.c_char_p]
            lib.validate_login.restype = ctypes.c_bool
            lib.get_current_totp.argtypes = []
            lib.get_current_totp.restype = ctypes.c_int
            lib.validate_totp.argtypes = [ctypes.c_int]
            lib.validate_totp.restype = ctypes.c_bool
            return lib
        except Exception as e:
            print(f"Note: Could not load C++ library: {e}")
            print("Using Python-only authentication (this is normal)")
            return None

    def setup_ui(self):
        # Clear existing (except background)
        for widget in self.root.winfo_children():
            if widget != self.bg_canvas:
                widget.destroy()
        
        # Glass panel container
        glass_container = tk.Frame(self.bg_canvas, bg="white")
        glass_container.place(relx=0.5, rely=0.5, anchor=tk.CENTER, width=480, height=680)  # Increased height for banner
        
        # Simulate glass effect with semi-transparent white
        glass_bg = tk.Frame(glass_container, bg="#FAFAFA")
        glass_bg.pack(fill=tk.BOTH, expand=True, padx=2, pady=2)
        
        # Add subtle border for depth
        glass_bg.config(highlightthickness=1, highlightbackground="#D0D0D0")
        
        if self.current_stage == 1:
            self.setup_login_screen(glass_bg)
        elif self.current_stage == 2:
            self.setup_mfa_screen(glass_bg)
        elif self.current_stage == 3:
            self.setup_signup_screen(glass_bg)
        elif self.current_stage == 4:
            self.setup_qr_setup_screen(glass_bg)
        
        
        # Bottom info section
        bottom_frame = tk.Frame(glass_bg, bg="#FAFAFA")
        bottom_frame.pack(fill=tk.X, pady=(10, 20), padx=20)
        
        
        # Conditional TOTP display based on mode
        if not PRODUCTION_MODE:
            totp_glass = tk.Frame(bottom_frame, bg="#FFF9E6", 
                                 highlightthickness=1, highlightbackground="#FFD700")
            totp_glass.pack(fill=tk.X, pady=(0, 8))
            
            self.totp_debug_label = tk.Label(
                totp_glass,
                text="üîî Current Valid TOTP: ---",
                fg="#8B7500",
                bg="#FFF9E6",
                font=("Consolas", 10, "bold"),
                pady=10
            )
            self.totp_debug_label.pack()
        else:
            # Production Mode: Show Google Authenticator button
            prod_frame = tk.Frame(bottom_frame, bg="#E3F2FD", 
                                 highlightthickness=1, highlightbackground="#2196F3")
            prod_frame.pack(fill=tk.X, pady=(0, 8))
            
            prod_label = tk.Label(
                prod_frame,
                text="üì± Use Google Authenticator for TOTP codes",
                fg="#1565C0",
                bg="#E3F2FD",
                font=("Segoe UI Semibold", 10),
                pady=8
            )
            prod_label.pack()
            
            setup_btn = tk.Button(
                prod_frame,
                text="‚öôÔ∏è Setup Authenticator",
                command=lambda: SetupWindow(self.root),
                font=("Segoe UI", 9),
                bg="#2196F3",
                fg="#FFFFFF",
                relief=tk.FLAT,
                cursor="hand2",
                padx=15,
                pady=5
            )
            setup_btn.pack(pady=(0, 8))
        
        # System status
        self.log_label = tk.Label(
            bottom_frame,
            text="‚óè System Ready | Secure Connection Active",
            fg="#666666",
            bg="#FAFAFA",
            font=("Segoe UI", 9)
        )
        self.log_label.pack()

    def setup_login_screen(self, parent):
        # Top spacing
        tk.Frame(parent, bg="#FAFAFA", height=35).pack()
        
        # Icon with glow effect
        icon_frame = tk.Frame(parent, bg="#FAFAFA")
        icon_frame.pack(pady=(0, 10))
        
        icon_label = tk.Label(
            icon_frame,
            text="üîê",
            font=("Segoe UI", 52),
            bg="#FAFAFA"
        )
        icon_label.pack()
        
        # Title with modern typography
        title = tk.Label(
            parent,
            text="Welcome Back",
            font=("Segoe UI Light", 28),
            fg="#1A1A1A",
            bg="#FAFAFA"
        )
        title.pack(pady=(0, 5))
        
        # Subtitle
        subtitle = tk.Label(
            parent,
            text="Sign in to your secure account",
            font=("Segoe UI", 11),
            fg="#666666",
            bg="#FAFAFA"
        )
        subtitle.pack(pady=(0, 30))
        
        # Login attempts counter
        if self.login_attempts > 0:
            attempts_color = "#D83B01" if self.login_attempts >= 3 else "#FFA500"
            attempts_label = tk.Label(
                parent,
                text=f"‚ö† Login attempts: {self.login_attempts}/{self.max_attempts}",
                font=("Segoe UI", 10),
                fg=attempts_color,
                bg="#FAFAFA"
            )
            attempts_label.pack(pady=(0, 10))
        
        # Form container
        form_container = tk.Frame(parent, bg="#FAFAFA")
        form_container.pack(fill=tk.BOTH, expand=True, padx=50)
        
        # Username
        username_label = tk.Label(
            form_container,
            text="Username",
            font=("Segoe UI Semibold", 10),
            fg="#1A1A1A",
            bg="#FAFAFA",
            anchor="w"
        )
        username_label.pack(fill=tk.X, pady=(0, 6))
        
        self.username_entry = ModernEntry(form_container, placeholder="Enter your username")
        self.username_entry.pack(fill=tk.X, ipady=2)
        self.username_entry.entry.focus_set()  # Auto-focus
        
        # Password
        password_label = tk.Label(
            form_container,
            text="Password",
            font=("Segoe UI Semibold", 10),
            fg="#1A1A1A",
            bg="#FAFAFA",
            anchor="w"
        )
        password_label.pack(fill=tk.X, pady=(18, 6))
        
        self.password_entry = ModernEntry(form_container, placeholder="Enter your password", show="‚óè")
        self.password_entry.pack(fill=tk.X, ipady=2)
        
        # Keyboard shortcut - Enter to login
        self.password_entry.entry.bind("<Return>", lambda e: self.handle_login())
        
        # Login button
        tk.Frame(form_container, bg="#FAFAFA", height=25).pack()
        
        self.login_btn = ModernButton(
            form_container,
            text="Sign In  ‚Üí",
            command=self.handle_login,
            primary=True,
            bg="#FAFAFA"
        )
        self.login_btn.pack(fill=tk.X, pady=(5, 0))
        
        # Create Account button
        tk.Frame(form_container, bg="#FAFAFA", height=10).pack()
        
        create_btn = ModernButton(
            form_container,
            text="Create Account",
            command=self.switch_to_signup,
            primary=False,
            bg="#FAFAFA"
        )
        create_btn.pack(fill=tk.X)
        
        # Keyboard shortcut hint
        hint = tk.Label(
            form_container,
            text="Press Enter to sign in",
            font=("Segoe UI", 9),
            fg="#999999",
            bg="#FAFAFA"
        )
        hint.pack(pady=(10, 0))
        
        tk.Frame(parent, bg="#FAFAFA", height=30).pack()

    def setup_mfa_screen(self, parent):
        # Top spacing
        tk.Frame(parent, bg="#FAFAFA", height=35).pack()
        
        # Icon
        icon_label = tk.Label(
            parent,
            text="üîë",
            font=("Segoe UI", 52),
            bg="#FAFAFA"
        )
        icon_label.pack(pady=(0, 10))
        
        # Title
        title = tk.Label(
            parent,
            text="Two-Factor Authentication",
            font=("Segoe UI Light", 26),
            fg="#1A1A1A",
            bg="#FAFAFA"
        )
        title.pack(pady=(0, 5))
        
        # Subtitle
        subtitle = tk.Label(
            parent,
            text="Enter the 6-digit code from your authenticator",
            font=("Segoe UI", 11),
            fg="#666666",
            bg="#FAFAFA"
        )
        subtitle.pack(pady=(0, 25))
        
        # TOTP countdown timer
        timer_frame = tk.Frame(parent, bg="#FAFAFA")
        timer_frame.pack(pady=(0, 20))
        
        self.totp_countdown = CircularProgress(timer_frame, size=70, bg="#FAFAFA")
        self.totp_countdown.pack()
        self.update_totp_countdown()
        
        # Form container
        form_container = tk.Frame(parent, bg="#FAFAFA")
        form_container.pack(fill=tk.BOTH, expand=True, padx=50)
        
        # TOTP field
        totp_label = tk.Label(
            form_container,
            text="Verification Code",
            font=("Segoe UI Semibold", 10),
            fg="#1A1A1A",
            bg="#FAFAFA",
            anchor="w"
        )
        totp_label.pack(fill=tk.X, pady=(0, 6))
        
        self.totp_entry = ModernEntry(form_container, placeholder="000000")
        self.totp_entry.pack(fill=tk.X, ipady=2)
        self.totp_entry.entry.config(font=("Consolas", 18), justify="center")
        self.totp_entry.entry.focus_set()  # Auto-focus
        
        
        # Enter to submit
        self.totp_entry.entry.bind("<Return>", lambda e: self.handle_totp())
        
        # Copy button for demo TOTP (only in demo mode)
        if not PRODUCTION_MODE:
            tk.Frame(form_container, bg="#FAFAFA", height=15).pack()
            
            copy_btn = ModernButton(
                form_container,
                text="üìã Copy Demo TOTP",
                command=self.copy_demo_totp,
                primary=False,
                bg="#FAFAFA"
            )
            copy_btn.pack(fill=tk.X)
        
        
        # Verify button
        tk.Frame(form_container, bg="#FAFAFA", height=15).pack()
        
        self.verify_btn = ModernButton(
            form_container,
            text="Verify Code  ‚úì",
            command=self.handle_totp,
            primary=True,
            bg="#FAFAFA"
        )
        self.verify_btn.pack(fill=tk.X, pady=(5, 0))
        
        # Keyboard shortcut hint
        hint = tk.Label(
            form_container,
            text="Press Enter to verify ‚Ä¢ ESC to go back",
            font=("Segoe UI", 9),
            fg="#999999",
            bg="#FAFAFA"
        )
        hint.pack(pady=(10, 0))
        
        tk.Frame(parent, bg="#FAFAFA", height=30).pack()

    def setup_signup_screen(self, parent):
        """Sign Up Screen"""
        # Top spacing
        tk.Frame(parent, bg="#FAFAFA", height=35).pack()
        
        # Icon with glow effect
        icon_frame = tk.Frame(parent, bg="#FAFAFA")
        icon_frame.pack(pady=(0, 10))
        
        icon_label = tk.Label(
            icon_frame,
            text="üë§",
            font=("Segoe UI", 52),
            bg="#FAFAFA"
        )
        icon_label.pack()
        
        # Title with modern typography
        title = tk.Label(
            parent,
            text="Create Account",
            font=("Segoe UI Light", 28),
            fg="#1A1A1A",
            bg="#FAFAFA"
        )
        title.pack(pady=(0, 5))
        
        # Subtitle
        subtitle = tk.Label(
            parent,
            text="Sign up for secure two-factor authentication",
            font=("Segoe UI", 11),
            fg="#666666",
            bg="#FAFAFA"
        )
        subtitle.pack(pady=(0, 30))
        
        # Form container
        form_container = tk.Frame(parent, bg="#FAFAFA")
        form_container.pack(fill=tk.BOTH, expand=True, padx=50)
        
        # Username
        username_label = tk.Label(
            form_container,
            text="Username",
            font=("Segoe UI Semibold", 10),
            fg="#1A1A1A",
            bg="#FAFAFA",
            anchor="w"
        )
        username_label.pack(fill=tk.X, pady=(0, 6))
        
        self.signup_username_entry = ModernEntry(form_container, placeholder="Choose a username")
        self.signup_username_entry.pack(fill=tk.X, ipady=2)
        self.signup_username_entry.entry.focus_set()  # Auto-focus
        
        # Password
        password_label = tk.Label(
            form_container,
            text="Password",
            font=("Segoe UI Semibold", 10),
            fg="#1A1A1A",
            bg="#FAFAFA",
            anchor="w"
        )
        password_label.pack(fill=tk.X, pady=(18, 6))
        
        self.signup_password_entry = ModernEntry(form_container, placeholder="Choose a strong password", show="‚óè")
        self.signup_password_entry.pack(fill=tk.X, ipady=2)
        
        # Password strength meter
        tk.Frame(form_container, bg="#FAFAFA", height=8).pack()
        self.signup_strength_meter = PasswordStrengthMeter(form_container, bg="#FAFAFA")
        self.signup_strength_meter.pack(fill=tk.X)
        
        # Update strength on password change
        self.signup_password_entry.entry.bind("<KeyRelease>", 
            lambda e: self.signup_strength_meter.update_strength(self.signup_password_entry.get()))
        
        # Keyboard shortcut - Enter to signup
        self.signup_password_entry.entry.bind("<Return>", lambda e: self.handle_signup())
        
        # Sign Up button
        tk.Frame(form_container, bg="#FAFAFA", height=25).pack()
        
        self.signup_btn = ModernButton(
            form_container,
            text="Sign Up  ‚Üí",
            command=self.handle_signup,
            primary=True,
            bg="#FAFAFA"
        )
        self.signup_btn.pack(fill=tk.X, pady=(5, 0))
        
        # Back to login button
        tk.Frame(form_container, bg="#FAFAFA", height=10).pack()
        
        back_btn = ModernButton(
            form_container,
            text="‚Üê Back to Login",
            command=self.switch_to_login,
            primary=False,
            bg="#FAFAFA"
        )
        back_btn.pack(fill=tk.X)
        
        tk.Frame(parent, bg="#FAFAFA", height=30).pack()

    def setup_qr_setup_screen(self, parent):
        """QR Code Setup Screen (shown after registration)"""
        # Top spacing
        tk.Frame(parent, bg="#FAFAFA", height=20).pack()
        
        # Title
        title = tk.Label(
            parent,
            text="üì± Setup Authenticator",
            font=("Segoe UI Light", 24),
            fg="#1A1A1A",
            bg="#FAFAFA"
        )
        title.pack(pady=(0, 10))
        
        # Instructions
        instructions = tk.Label(
            parent,
            text="Scan this QR code with Google Authenticator:",
            font=("Segoe UI", 11),
            fg="#666666",
            bg="#FAFAFA"
        )
        instructions.pack(pady=(0, 15))
        
        # Generate and display QR code
        qr_frame = tk.Frame(parent, bg="#FAFAFA")
        qr_frame.pack(pady=(0, 20))
        
        qr_image = self.generate_qr_for_user(self.current_username, self.pending_signup_secret)
        qr_label = tk.Label(qr_frame, image=qr_image, bg="#FAFAFA")
        qr_label.image = qr_image  # Keep reference
        qr_label.pack()
        
        # Secret display (in case QR doesn't work)
        secret_frame = tk.Frame(parent, bg="#F5F5F5", highlightthickness=1, highlightbackground="#E0E0E0")
        secret_frame.pack(fill=tk.X, padx=50, pady=(10, 20))
        
        secret_label = tk.Label(
            secret_frame,
            text=f"Secret Key: {self.pending_signup_secret}",
            font=("Consolas", 9, "bold"),
            fg="#0078D4",
            bg="#F5F5F5"
        )
        secret_label.pack(pady=8)
        
        # Continue button
        continue_btn = ModernButton(
            parent,
            text="Done - Go to Login  ‚Üí",
            command=self.finish_signup,
            primary=True,
            bg="#FAFAFA"
        )
        continue_btn.pack(padx=50, fill=tk.X, pady=(10, 20))
        
        tk.Frame(parent, bg="#FAFAFA", height=20).pack()

    def generate_qr_for_user(self, username, secret):
        """Generate QR code for a specific user's TOTP secret"""
        totp_uri = f"otpauth://totp/{ISSUER}:{username}?secret={secret}&issuer={ISSUER}"
        
       # Generate QR code
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_L,
            box_size=8,
            border=2,
        )
        qr.add_data(totp_uri)
        qr.make(fit=True)
        
        # Create image
        qr_image = qr.make_image(fill_color="black", back_color="white")
        
        # Convert to PhotoImage for tkinter
        qr_photo = ImageTk.PhotoImage(qr_image)
        
        return qr_photo


    def copy_demo_totp(self):
        """Copy current TOTP to clipboard"""
        try:
            totp_code = self.get_current_totp_code()
            self.root.clipboard_clear()
            self.root.clipboard_append(totp_code)
            self.log_label.config(text="‚úì TOTP copied to clipboard!", fg="#107C10")
            
            # Show the TOTP code in a message box
            messagebox.showinfo("TOTP Copied", 
                f"Code copied to clipboard:\n\n{totp_code}\n\nPaste it in the verification field below.")
            
            # Reset message after 2 seconds
            self.root.after(2000, lambda: self.log_label.config(
                text="‚óè System Ready | Secure Connection Active", fg="#666666"))
        except Exception as e:
            messagebox.showerror("Error", f"Failed to copy TOTP: {e}")

    def update_totp_countdown(self):
        """Update the circular TOTP countdown timer"""
        if hasattr(self, 'totp_countdown'):
            # Calculate seconds until next 30-second interval
            current_time = int(time.time())
            seconds_remaining = 30 - (current_time % 30)
            self.totp_countdown.set_progress(seconds_remaining, 30)
            # Update every second
            self.root.after(1000, self.update_totp_countdown)

    def handle_login(self):
        username = self.username_entry.get()
        password = self.password_entry.get()
        
        # Validation
        if not username or not password:
            messagebox.showwarning("Missing Information", "Please enter both username and password.")
            return
        
        # Check max attempts
        if self.login_attempts >= self.max_attempts:
            messagebox.showerror("Account Locked", 
                f"Too many failed attempts. Account temporarily locked.\nPlease try again later.")
            return
        
        # Security Check: Buffer Overflow Prevention
        if len(password) > 50:
            self.log_label.config(text="‚ö† SECURITY: Buffer Overflow Prevented!", fg="#D83B01")
            return
        else:
            self.log_label.config(text="‚óè Processing authentication...", fg="#0078D4")

        # Validate credentials using database
        try:
            if user_db.validate_credentials(username, password):
                self.login_attempts = 0  # Reset on success
                self.current_username = username  # Store for TOTP verification
                self.current_stage = 2
                self.setup_ui()
            else:
                self.login_attempts += 1
                remaining = self.max_attempts - self.login_attempts
                messagebox.showerror("Authentication Failed", 
                    f"Invalid username or password.\n{remaining} attempts remaining.")
                self.log_label.config(text=f"‚óè Authentication failed ({self.login_attempts}/{self.max_attempts})", 
                                    fg="#D83B01")
                self.setup_ui()  # Refresh to show attempt counter
        except Exception as e:
            messagebox.showerror("Error", f"Authentication error: {e}")

    def handle_totp(self):
        code_str = self.totp_entry.get()
        
        if not code_str:
            messagebox.showwarning("Missing Code", "Please enter the verification code.")
            return
            
        if not code_str.isdigit():
            messagebox.showerror("Invalid Input", "Code must contain only numbers.")
            return
        
        if len(code_str) != 6:
            messagebox.showerror("Invalid Code", "Code must be exactly 6 digits.")
            return
            
        try:
            # Verify TOTP using database
            if user_db.verify_totp(self.current_username, code_str):
                # Success animation
                self.log_label.config(text="‚úì Authentication Complete!", fg="#107C10")
                messagebox.showinfo("Success", f"‚úì Authentication Complete!\n\nAccess Granted.\n\nWelcome, {self.current_username}!")
                self.root.quit()
            else:
                messagebox.showerror("Verification Failed", "Invalid or expired TOTP code.\n\nPlease try again with the current code.")
                self.log_label.config(text="‚óè Verification failed - Please retry", fg="#D83B01")
        except Exception as e:
            messagebox.showerror("Error", f"Verification error: {e}")

    def handle_signup(self):
        """Handle user registration"""
        username = self.signup_username_entry.get()
        password = self.signup_password_entry.get()
        
        # Register user
        success, message, totp_secret = user_db.register_user(username, password)
        
        if success:
            # Store the secret for QR display
            self.pending_signup_secret = totp_secret
            self.current_username = username
            
            # Switch to QR setup screen
            self.current_stage = 4
            self.setup_ui()
        else:
            messagebox.showerror("Registration Failed", message)
    
    def switch_to_signup(self):
        """Switch to signup screen"""
        self.current_stage = 3
        self.setup_ui()
    
    def switch_to_login(self):
        """Switch back to login screen"""
        self.current_stage = 1
        self.login_attempts = 0
        self.setup_ui()
    
    def finish_signup(self):
        """Complete signup and return to login"""
        messagebox.showinfo("Success", f"‚úì Account created successfully!\n\nYou can now log in with your credentials.\n\nMake sure to use the TOTP code from your authenticator app.")
        self.pending_signup_secret = None
        self.current_username = None
        self.current_stage = 1
        self.setup_ui()

    def update_demo_totp(self):
        """Poll C++ backend for current code (only in demo mode)"""
        if not PRODUCTION_MODE and self.lib and hasattr(self, 'totp_debug_label'):
            try:
                code = self.lib.get_current_totp()
                self.totp_debug_label.config(text=f"üîî Current Valid TOTP: {code:06d}")
            except:
                self.totp_debug_label.config(text="üîî Current Valid TOTP: Error")
        
        self.root.after(1000, self.update_demo_totp)
    
    def get_current_totp_code(self):
        """Get current TOTP code based on mode"""
        if PRODUCTION_MODE:
            # Use pyotp for RFC 6238 standard TOTP
            return totp_generator.now()
        else:
            # Use C++ backend for demo mode
            if self.lib:
                return f"{self.lib.get_current_totp():06d}"
            return "000000"
    
    def verify_totp_code(self, user_code):
        """Verify TOTP code based on mode"""
        if PRODUCTION_MODE:
            # Use pyotp for RFC 6238 standard verification
            return totp_generator.verify(user_code, valid_window=1)
        else:
            # Use C++ backend for demo mode
            if self.lib:
                try:
                    code_int = int(user_code)
                    return self.lib.validate_totp(code_int)
                except:
                    return False
            return False


if __name__ == "__main__":
    root = tk.Tk()
    app = SecureAuthApp(root)
    root.mainloop()


================================================================================
FILE 3: auth_core.cpp - C++ Security Backend (Legacy/Optional)
================================================================================

#include <cstdint>
#include <cstdio>
#include <cstdlib>
#include <cstring>
#include <ctime>
#include <iostream>

// --- Security Constants ---
// DJB2 hash of "admin123"
const uint32_t STORED_PASSWORD_HASH =
    407908580UL; // Verified DJB2 hash for "admin123"
const char *TOTP_SECRET = "MY_SUPER_SECRET_KEY";

// --- Helper Functions ---

// DJB2 Hash Function
uint32_t djb2_hash(const char *str) {
  uint32_t hash = 5381;
  int c;
  while ((c = *str++))
    hash = ((hash << 5) + hash) + c; /* hash * 33 + c */
  return hash;
}

// Secure String Copy to prevent buffer overflows
// Copies at most dest_size - 1 characters, ensuring null termination.
void secure_strcpy(char *dest, const char *src, size_t dest_size) {
  if (dest_size == 0)
    return;

  // Use strncpy for bounded copy
  strncpy(dest, src, dest_size - 1);

  // Explicitly ensure null termination
  dest[dest_size - 1] = '\0';
}

// Generate TOTP code based on time and secret
// Simplified TOTP: (Time / 30 + Hash(Secret)) % 1000000
int generate_totp(time_t current_time) {
  uint32_t secret_hash = djb2_hash(TOTP_SECRET);
  uint32_t time_step = (uint32_t)(current_time / 30);

  // Combine time and secret
  uint32_t combined = time_step + secret_hash;

  // Generate 6-digit code
  return combined % 1000000;
}

// --- Exported Functions for Python ---

extern "C" {

// Validate Login Credentials
// Returns true if username is "admin" and password hash matches.
bool validate_login(const char *username, const char *password) {
  // Securely copy inputs to local buffers to demonstrate secure_strcpy usage
  char safe_username[50];
  char safe_password[50];

  secure_strcpy(safe_username, username, sizeof(safe_username));
  secure_strcpy(safe_password, password, sizeof(safe_password));

  // Check username
  if (strcmp(safe_username, "admin") != 0) {
    return false;
  }

  // Check password hash
  uint32_t input_hash = djb2_hash(safe_password);

  return input_hash == STORED_PASSWORD_HASH;
}

// Get Current TOTP (For Demo/Debugging)
int get_current_totp() { return generate_totp(std::time(0)); }

// Validate User's TOTP Input
bool validate_totp(int user_code) {
  time_t now = std::time(0);

  // Check current window only (strict 30-second validation)
  if (generate_totp(now) == user_code)
    return true;

  return false;
}
}


================================================================================
FILE 4: config.py - Configuration Settings
================================================================================

# Configuration File for Secure Authentication System
# Toggle between Production and Demo modes

# =============================================================================
# MODE CONFIGURATION
# =============================================================================

# Set to True for production deployment (hides demo TOTP display)
# Set to False for demo/testing (shows TOTP on screen)
PRODUCTION_MODE = True

# =============================================================================
# TOTP CONFIGURATION
# =============================================================================

# TOTP Secret Key (Base32 encoded for Google Authenticator compatibility)
# This is a valid Base32 string that Google Authenticator can use
TOTP_SECRET = "JBSWY3DPEHPK3PXP"  # Base32: "Hello!"

# For demo mode, we also keep the original secret for C++ backend
TOTP_SECRET_DEMO = "MY_SUPER_SECRET_KEY"

# Application Details for Google Authenticator
APP_NAME = "SecureAuthSystem"
ISSUER = "SecureAuth"
ACCOUNT_NAME = "admin"

# =============================================================================
# SECURITY SETTINGS
# =============================================================================

# Maximum login attempts before account lockout
MAX_LOGIN_ATTEMPTS = 5

# TOTP window in seconds (strict validation)
TOTP_WINDOW_SECONDS = 30

# =============================================================================
# NOTES
# =============================================================================
# 
# Production Mode vs Demo Mode:
# ------------------------------
# Demo Mode (PRODUCTION_MODE = False):
#   - Shows current TOTP code on screen
#   - Displays "Copy Demo TOTP" button
#   - Useful for testing and demonstrations
#
# Production Mode (PRODUCTION_MODE = True):
#   - Hides TOTP code display
#   - Requires Google Authenticator or compatible app
#   - Shows setup instructions window on first run
#   - More secure for real deployments
#
# Google Authenticator Setup:
# ----------------------------
# 1. Set PRODUCTION_MODE = True
# 2. Run the application
# 3. Click "Setup Authenticator" button
# 4. Scan QR code with Google Authenticator app
# 5. Enter the 6-digit code to authenticate
#


================================================================================
FILE 5: build.py - Build Script
================================================================================

import os
import sys
import subprocess
import platform
import time

def main():
    print("--- Secure Auth Project Build System ---")
    
    # 1. Detect OS
    system = platform.system()
    print(f"Detected OS: {system}")
    
    # 2. Determine Compiler Command
    src_file = "auth_core.cpp"
    
    if system == "Windows":
        out_file = "auth_lib.dll"
        # Ensure we use g++
        cmd = ["g++", "-shared", "-o", out_file, src_file]
    elif system == "Linux" or system == "Darwin": # Darwin is Mac
        out_file = "auth_lib.so"
        cmd = ["g++", "-shared", "-o", out_file, "-fPIC", src_file]
    else:
        print(f"Unsupported OS: {system}")
        sys.exit(1)
        
    print(f"Compiling {src_file} -> {out_file}...")
    print(f"Command: {' '.join(cmd)}")
    
    # 3. Execute Compilation
    try:
        # Run in the script's directory
        cwd = os.path.dirname(os.path.abspath(__file__))
        subprocess.check_call(cmd, cwd=cwd)
        print("Compilation Successful!")
    except subprocess.CalledProcessError as e:
        print("Error: Compilation failed.")
        sys.exit(1)
    except FileNotFoundError:
        print("Error: 'g++' not found. Please ensure MinGW (Windows) or GCC (Linux/Mac) is installed and in PATH.")
        sys.exit(1)

    # 4. Check if library exists
    lib_path = os.path.join(cwd, out_file)
    if os.path.exists(lib_path):
        print(f"Library verified at: {lib_path}")
    else:
        print("Error: Library file not found after compilation.")
        sys.exit(1)

    # 5. Launch GUI
    print("Launching GUI...")
    gui_script = "main_gui.py"
    try:
        # Use the same python interpreter
        subprocess.check_call([sys.executable, gui_script], cwd=cwd)
    except subprocess.CalledProcessError as e:
        print(f"GUI exited with error: {e}")

if __name__ == "__main__":
    main()


================================================================================
END OF SOURCE CODE LISTING
================================================================================
